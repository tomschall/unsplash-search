<script lang="ts">
  import { onMount } from 'svelte';
  import Search from './Search.svelte';
  import SearchResults from './SearchResults.svelte';
  import LoadingIndicator from './LoadingIndicator.svelte';

  const UNSPLASH_ACCESS_KEY: string =
    'lrb6doO5sPdVClLRce7mMMa9De5AT6ho4owTkvBQ14I';

  let searchQuery: string = '';
  let searchTerm: string = null;
  let totalPages: number = null;
  let searchResults: string[] = [];
  let nextPage: number = 1;
  let isLoading: boolean = false;

  let observer: any;
  let target: any;

  interface ObserverOptions {
    rootMargin: string;
    threshold: number;
  }

  const options: ObserverOptions = {
    rootMargin: '0px 0px 300px',
    threshold: 0,
  };

  const loadMoreResults = (entries: any) => {
    entries.forEach((entry: any) => {
      // If new search or if ongoing search
      if (nextPage === 1 || isLoading) return;

      if (entry.isIntersecting) {
        searchUnsplash();
      }
    });
  };

  onMount(() => {
    observer = new IntersectionObserver(loadMoreResults, options);
    target = document.querySelector('.loading-indicator');
  });

  function handleSubmit() {
    searchTerm = searchQuery.trim();
    console.log('searchTerm', searchTerm);
    searchResults = [];
    totalPages = null;
    nextPage = 1;

    if (!searchTerm) return;

    observer.observe(target);
    searchUnsplash();
  }

  function searchUnsplash() {
    isLoading = true;

    const endpoint =
      // `http://localhost:5000/searchbar.json`;
      `https://www.fhnw.ch/de/searchbar.json?q=${searchTerm}&category=all`
      // `https://api.unsplash.com/search/photos?query=${searchTerm}&page=${nextPage}&per_page=28&client_id=${UNSPLASH_ACCESS_KEY}`;

    fetch(endpoint)
      .then(response => {
        if (!response.ok) {
          throw Error(response.statusText);
        }
        return response.json();
      })
      .then(data => {
        
        if (data.total === 0) {
          console.log("No photos were found for your search query.")
          return;
        }
        
        searchResults = [...searchResults, ...data.items];
        // console.log('1 item', data.items[0].Description);
        // console.log('items', data.items);
        // console.log('total items', data.items_total);
        console.log('SEARCH RESULTS', searchResults);

        // totalPages = data.total_pages;

        // if (nextPage < totalPages) {
        //   nextPage += 1;
        // }
      })
      .catch(() => console.log("An error occured!"))
      .finally(() => {
        isLoading = false;

        // if (nextPage >= Number(totalPages)) {
        //   observer.unobserve(target);
        // }
      });
  }  
</script>

<div class="widg_search_svelte">
  <Search bind:query={searchQuery} handleSubmit={handleSubmit} />
  <SearchResults results={searchResults} />
  <div class="loading-indicator">
    {#if isLoading}
      <LoadingIndicator />
    {/if}
  </div>
</div>
